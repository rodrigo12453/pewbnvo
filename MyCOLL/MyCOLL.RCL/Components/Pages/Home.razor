@page "/"
@using MyCOLL.RCL
@using MyCOLL.RCL.Services
@using MyCOLL.Data
@using System.Net.Http.Json
@inject HttpClient Http
@inject CarrinhoService CarrinhoSvc

<PageTitle>NOME LOJA - A Tua Montra</PageTitle>

<div class="p-5 mb-4 bg-light rounded-3 text-center border">
    <div class="container-fluid py-3">
        <h1 class="display-5 fw-bold">Bem-vindo à NOME LOJA</h1>
        <p class="col-md-8 fs-4 mx-auto">Encontra os melhores produtos aos melhores preços.</p>
    </div>
</div>

<h3 class="mb-4">🔥 Destaques da Semana</h3>

@if (produtos == null)
{
    <p class="text-center"><em>A carregar a montra da API...</em></p>
}
else if (!produtos.Any())
{
    <div class="alert alert-info">
        Ainda não há produtos à venda. (Verifica se a API está a correr e se tens dados na BD!)
    </div>
}
else
{
    <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
        @foreach (var prod in produtos)
        {
            <div class="col">
                <div class="card h-100 shadow-sm">
                    <div style="height: 200px; overflow: hidden; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa;">
                        @if (!string.IsNullOrEmpty(prod.ImagemUrl))
                        {
                            <img src="@prod.ImagemUrl" class="card-img-top" alt="@prod.Nome" style="object-fit: cover; height: 100%; width: 100%;">
                        }
                        else
                        {
                            <span class="text-muted"><i class="bi bi-camera fs-1"></i></span>
                        }
                    </div>

                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title text-truncate">@prod.Nome</h5>
                        <p class="card-text small text-muted">@prod.Categoria?.Nome</p>

                        <div class="mt-auto d-flex justify-content-between align-items-center">
                            <span class="fs-5 fw-bold text-primary">@prod.PrecoVenda.ToString("C")</span>

                            @if (prod.Stock > 0)
                            {
                                <button class="btn btn-success btn-sm" @onclick="() => AdicionarAoCarrinho(prod)">
                                    <i class="bi bi-cart-plus"></i> Adicionar
                                </button>
                            }
                            else
                            {
                                <span class="badge bg-danger">Esgotado</span>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private List<Produto>? produtos;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Agora vai buscar à API em vez de ir direto à BD
            produtos = await Http.GetFromJsonAsync<List<Produto>>("api/produtos");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar produtos: {ex.Message}");
            produtos = new List<Produto>();
        }
    }

    private void AdicionarAoCarrinho(Produto p)
    {
        CarrinhoSvc.Adicionar(p);
    }
}