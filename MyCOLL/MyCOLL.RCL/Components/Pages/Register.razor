@page "/Account/Register"
@using MyCOLL.RCL
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Registar Conta - MyCOLL</PageTitle>

<div class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
    <div class="card shadow-lg p-4" style="width: 400px; border-radius: 15px;">
        <div class="text-center mb-4">
            <i class="bi bi-person-plus-fill fs-1 text-success"></i>
            <h2 class="fw-bold mt-2">Criar Conta</h2>
            <p class="text-muted">Junta-te à nossa loja!</p>
        </div>

        @if (!string.IsNullOrEmpty(mensagemErro))
        {
            <div class="alert alert-danger text-center" style="word-wrap: break-word;">
                @mensagemErro
            </div>
        }

        <div class="mb-3">
            <label class="form-label fw-bold">Email</label>
            <input type="email" @bind="registerModel.Email" class="form-control" placeholder="exemplo@email.com" />
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Password</label>
            <input type="password" @bind="registerModel.Password" class="form-control" placeholder="******" />
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Confirmar Password</label>
            <input type="password" @bind="registerModel.ConfirmPassword" class="form-control" placeholder="******" />
        </div>

        <button class="btn btn-success w-100 py-2 fw-bold" @onclick="RegistarUser" disabled="@processando">
            @if (processando)
            {
                <span>A criar conta...</span>
            }
            else
            {

                <span>Registar</span>
            }
        </button>

        <div class="text-center mt-3">
            <p class="small">Já tens conta? <a href="Account/Login">Faz Login aqui</a></p>
        </div>
    </div>
</div>

@code {
    private RegisterDto registerModel = new RegisterDto();
    private string mensagemErro = "";
    private bool processando = false;

    private async Task RegistarUser()
    {
        processando = true;
        mensagemErro = "";

        // 1. Validação local
        if (registerModel.Password != registerModel.ConfirmPassword)
        {
            mensagemErro = "As passwords não coincidem.";
            processando = false;
            return;
        }

        try
        {
            // 2. Tentar chamar a API
            var response = await Http.PostAsJsonAsync("api/auth/register", registerModel);

            // 3. Ler o que a API respondeu
            var conteudoResposta = await response.Content.ReadAsStringAsync();

            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "CONTA CRIADA! 🎉");
                Nav.NavigateTo("Account/Login");
            }
            else
            {
                // MOSTRAR O ERRO REAL NO ECRÃ
                mensagemErro = $"A API rejeitou ({response.StatusCode}): {conteudoResposta}";
            }
        }
        catch (Exception ex)
        {
            // MOSTRAR O ERRO DE LIGAÇÃO
            mensagemErro = $"ERRO DE LIGAÇÃO: {ex.Message}";
        }
        finally
        {
            processando = false;
        }
    }
}